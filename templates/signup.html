{% extends "base.html" %}
{% block content %}
<head>
    <meta charset="UTF-8">
    <title>Signup</title>
    <style>
        body {
            background: url('/static/images/bg.jpg') no-repeat center center fixed;
            background-size: cover;
            font-family: Arial, sans-serif;
        }
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0px 0px 20px rgba(0,0,0,0.2);
        }
        input[type="email"], input[type="password"], input[type="url"] {
            width: 100%;
        }
        button, .btn {
            width: 100%;
        }
    </style>
</head>
<div class="form-card">
  <div class="auth-container">
    <h2 class="text-center mb-4">üìù Signup</h2>
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    {% if message %}
      <div class="alert alert-success">{{ message|safe }}</div>
      {% if public_key %}
        <label>Your Public Key (Share this):</label>
        <textarea id="public_key" class="form-control mb-2" rows="6" readonly>{{ public_key }}</textarea>
        <button onclick="copyPublicKey()" class="btn btn-outline-primary w-100 mb-3">üìã Copy Public Key</button>
        <p class="mt-2">Please follow these steps to share your public key:</p>
        <ol>
          <li>Go to <a href="https://github.com" target="_blank">GitHub</a> and create a public repository or Gist.</li>
          <li>Paste your public key into a file (e.g., <code>public_key.pem</code>) in the repository or as the Gist content.</li>
          <li>Copy the raw URL (e.g., <code>https://raw.githubusercontent.com/username/repo/main/public_key.pem</code> or <code>https://gist.githubusercontent.com/username/gist_id/raw</code>).</li>
          <li>Paste the URL below to verify your public key.</li>
        </ol>
        {% if key_verification_url %}
          <p>Verification URL: <a href="{{ key_verification_url }}" target="_blank">{{ key_verification_url }}</a></p>
        {% endif %}
        <form method="post">
          <input type="hidden" name="email" value="{{ session['email'] }}">
          <input type="hidden" name="password" value="">
          <input type="hidden" name="public_key" value="{{ public_key }}">
          <div class="mt-3 text-center">
            <a href="{{ url_for('login') }}">‚Üê Back to Login</a>
          </div>
        </form>
      {% endif %}
    {% endif %}
    {% if not public_key %}
    <form method="post" onsubmit="return handleSignup(event)">
      <div class="mb-3">
        <label>Email:</label>
        <input type="email" class="form-control" name="email" required>
      </div>
      <div class="mb-3">
        <label>Password:</label>
        <input type="password" class="form-control" name="password" required>
      </div>
      <input type="hidden" name="public_key" id="public_key_input">
      <button type="submit" class="btn btn-success w-100">Signup</button>
      <div class="mt-3 text-center">
        <a href="{{ url_for('login') }}">‚Üê Back to Login</a>
      </div>
    </form>
    {% endif %}
  </div>
</div>
<script>
function arrayBufferToBase64(buffer) {
  const bytes = new Uint8Array(buffer);
  let binary = '';
  for (let i = 0; i < bytes.length; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary).replace(/(.{64})/g, "$1\n").trim();
}

async function handleSignup(event) {
  event.preventDefault();
  try {
    // Generate RSA key pair
    const keyPair = await crypto.subtle.generateKey(
      {
        name: "RSA-OAEP",
        modulusLength: 2048,
        publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
        hash: "SHA-256"
      },
      true,
      ["encrypt", "decrypt"]
    );

    // Export public key to PEM
    const publicKey = await crypto.subtle.exportKey("spki", keyPair.publicKey);
    const publicKeyBase64 = arrayBufferToBase64(publicKey);
    const publicKeyPem = `-----BEGIN PUBLIC KEY-----\n${publicKeyBase64}\n-----END PUBLIC KEY-----`;

    // Export private key to PEM and store in localStorage
    const privateKey = await crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
    const privateKeyBase64 = arrayBufferToBase64(privateKey);
    const privateKeyPem = `-----BEGIN PRIVATE KEY-----\n${privateKeyBase64}\n-----END PRIVATE KEY-----`;
    
    // Store private key and verify
    localStorage.setItem('private_key', privateKeyPem);
    if (localStorage.getItem('private_key') !== privateKeyPem) {
      throw new Error("Failed to store private key in localStorage");
    }
    console.log("Private key stored successfully:", privateKeyPem.substring(0, 50) + "...");

    // Set public key in form
    document.getElementById('public_key_input').value = publicKeyPem;

    // Submit form
    event.target.submit();
  } catch (err) {
    console.error('Signup error:', err);
    alert('Signup failed: ' + (err.message || 'Unknown error'));
    return false;
  }
}

function copyPublicKey() {
  const publicKey = document.getElementById('public_key').value;
  navigator.clipboard.writeText(publicKey)
    .then(() => alert('‚úÖ Public key copied!'))
    .catch(err => alert('‚ùå Failed to copy. Copy manually.'));
}
</script>
{% endblock %}